---
title: Docker Compose 部署
description: OpenDeepWiki 的完整 Docker Compose 部署指南，包括环境变量、卷和生产配置。
---

import { Callout } from "fumadocs-ui/components/callout";

# Docker Compose 部署

OpenDeepWiki 在项目根目录提供 `compose.yaml`，定义了两个服务：后端 API 和前端 web 应用。

## 服务架构

| 服务 | 端口 | 描述 |
|---|---|---|
| `opendeepwiki` | `8080` | 带有 AI 处理的 ASP.NET Core 后端 API |
| `web` | `3000` | Next.js 前端应用 |

前端依赖于后端，并在其健康检查通过后才启动。

## 快速部署

```bash
# 克隆仓库
git clone https://github.com/AIDotNet/OpenDeepWiki.git
cd OpenDeepWiki

# 编辑 compose.yaml 中的环境变量（见下文）
# 然后启动所有服务
docker-compose up -d
```

在 `http://localhost:3000` 访问应用。

## 完整 compose.yaml 参考

```yaml
services:
  opendeepwiki:
    image: crpi-j9ha7sxwhatgtvj4.cn-shenzhen.personal.cr.aliyuncs.com/open-deepwiki/opendeepwiki
    build:
      context: .
      dockerfile: src/OpenDeepWiki/Dockerfile
    ports:
      - "8080:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - URLS=http://+:8080

      # 数据库
      - DB_TYPE=sqlite
      - CONNECTION_STRING=Data Source=/data/opendeepwiki.db

      # JWT
      - JWT_SECRET_KEY=your-secret-key-change-in-production

      # 仓库存储
      - REPOSITORIES_DIRECTORY=/data

      # AI 服务（聊天）
      - CHAT_API_KEY=your-api-key
      - ENDPOINT=https://api.openai.com/v1
      - CHAT_REQUEST_TYPE=OpenAI

      # Wiki 目录生成
      - WIKI_CATALOG_MODEL=gpt-4o
      - WIKI_CATALOG_ENDPOINT=https://api.openai.com/v1
      - WIKI_CATALOG_API_KEY=your-api-key
      - WIKI_CATALOG_REQUEST_TYPE=OpenAI

      # Wiki 内容生成
      - WIKI_CONTENT_MODEL=gpt-4o
      - WIKI_CONTENT_ENDPOINT=https://api.openai.com/v1
      - WIKI_CONTENT_API_KEY=your-api-key
      - WIKI_CONTENT_REQUEST_TYPE=OpenAI

      # Wiki 翻译（可选，回退到内容配置）
      # - WIKI_TRANSLATION_MODEL=gpt-4o
      # - WIKI_TRANSLATION_ENDPOINT=https://api.openai.com/v1
      # - WIKI_TRANSLATION_API_KEY=your-api-key
      # - WIKI_TRANSLATION_REQUEST_TYPE=OpenAI

      # 并行生成数量
      - WIKI_PARALLEL_COUNT=5

      # 多语言支持（逗号分隔）
      - WIKI_LANGUAGES=en,zh
    volumes:
      - ./data:/data

  web:
    image: crpi-j9ha7sxwhatgtvj4.cn-shenzhen.personal.cr.aliyuncs.com/open-deepwiki/opendeepwiki-web
    build:
      context: ./web
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    restart: unless-stopped
    depends_on:
      opendeepwiki:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - API_PROXY_URL=http://opendeepwiki:8080
```

## 环境变量

### 必需变量

| 变量 | 描述 | 示例 |
|---|---|---|
| `CHAT_API_KEY` | 聊天 AI 服务的 API 密钥 | `sk-...` |
| `ENDPOINT` | 聊天 AI 服务端点 | `https://api.openai.com/v1` |
| `WIKI_CATALOG_API_KEY` | 目录生成的 API 密钥 | `sk-...` |
| `WIKI_CATALOG_ENDPOINT` | 目录生成端点 | `https://api.openai.com/v1` |
| `WIKI_CONTENT_API_KEY` | 内容生成的 API 密钥 | `sk-...` |
| `WIKI_CONTENT_ENDPOINT` | 内容生成端点 | `https://api.openai.com/v1` |

### 可选变量

| 变量 | 默认值 | 描述 |
|---|---|---|
| `DB_TYPE` | `sqlite` | 数据库类型：`sqlite` 或 `postgresql` |
| `CONNECTION_STRING` | `Data Source=/data/opendeepwiki.db` | 数据库连接字符串 |
| `JWT_SECRET_KEY` | 内置默认值 | JWT 签名密钥（生产环境需更改） |
| `WIKI_CATALOG_MODEL` | `gpt-4o` | 目录生成模型 |
| `WIKI_CONTENT_MODEL` | `gpt-4o` | 内容生成模型 |
| `CHAT_REQUEST_TYPE` | `OpenAI` | AI 提供商类型 |
| `WIKI_PARALLEL_COUNT` | `5` | 并行 wiki 生成任务数 |
| `WIKI_LANGUAGES` | `en,zh` | 支持的语言（逗号分隔） |

<Callout type="warn">
  在生产环境中始终更改 `JWT_SECRET_KEY`。默认密钥仅用于开发。
</Callout>

## 数据持久化

后端将所有数据存储在映射到 `./data` 的 Docker 卷中：

```yaml
volumes:
  - ./data:/data
```

此目录包含：
- SQLite 数据库文件（使用 SQLite 时）
- 用于分析的克隆仓库文件
- 生成的文档数据

<Callout type="warn">
  定期备份 `./data` 目录。它包含所有生成的文档和仓库数据。
</Callout>

## 健康检查

后端包含内置的健康检查端点：

```yaml
healthcheck:
  test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 15s
```

前端在此健康检查通过后才启动，确保 API 已准备好接受请求。

## 构建镜像

```bash
# 构建所有镜像
docker-compose build

# 为特定架构构建
docker-compose build --build-arg ARCH=arm64   # Apple Silicon、AWS Graviton
docker-compose build --build-arg ARCH=amd64   # Intel/AMD x86_64

# 构建单个服务
docker-compose build opendeepwiki   # 仅后端
docker-compose build web            # 仅前端
```

如果已安装 `make`：

```bash
make build          # 构建全部
make build-arm      # ARM 架构
make build-amd      # AMD 架构
```

## 常见操作

```bash
# 后台启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 查看特定服务的日志
docker-compose logs -f opendeepwiki

# 重启服务
docker-compose restart

# 停止服务
docker-compose down
```

## 一键部署

### Sealos

一键部署 OpenDeepWiki 到 Sealos：

[![Deploy on Sealos](https://raw.githubusercontent.com/labring-actions/templates/main/Deploy-on-Sealos.svg)](https://bja.sealos.run/?openapp=system-template%3FtemplateName%3DOpenDeepWiki)

## 故障排除

### 后端启动失败

- 验证 AI API 密钥有效且端点可达
- 检查 `CONNECTION_STRING` 与你的数据库类型匹配
- 查看日志：`docker-compose logs opendeepwiki`

### 前端显示连接错误

- 确保后端健康检查通过：`docker-compose ps`
- `API_PROXY_URL` 必须指向后端容器：`http://opendeepwiki:8080`

### 磁盘空间不足

- 克隆的仓库存储在 `./data` 中。通过 web UI 或 API 清理旧仓库
- 对于大型部署，考虑从 SQLite 切换到 [PostgreSQL](/docs/deployment/database)
