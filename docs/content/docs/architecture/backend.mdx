---
title: 后端架构
description: ASP.NET Core 后端架构详情 — API 端点、服务层、AI 集成和后台工作者。
---

## 概览

OpenDeepWiki 后端是一个 ASP.NET Core 应用，目标是 .NET 10，位于 `src/OpenDeepWiki/`。它使用最小 API 进行端点路由，Entity Framework Core 进行数据访问，并与多个 AI 提供商集成以实现 wiki 生成和聊天功能。

## 项目结构

```
src/OpenDeepWiki/
├── Program.cs                 # 应用入口和服务注册
├── Endpoints/                 # 最小 API 端点定义
│   ├── AuthEndpoints.cs       # 认证（注册、登录、JWT）
│   ├── OAuthEndpoints.cs      # OAuth 提供商集成
│   ├── ChatEndpoints.cs       # Wiki 文档检索和 MCP 协议
│   ├── ChatAssistantEndpoints.cs  # SSE 流式聊天助手
│   ├── ChatAppEndpoints.cs    # 用户应用管理（CRUD、密钥、统计）
│   ├── EmbedEndpoints.cs      # 可嵌入聊天小部件 API
│   ├── IncrementalUpdateEndpoints.cs  # 增量更新触发
│   ├── OrganizationEndpoints.cs       # 组织管理
│   ├── SystemEndpoints.cs     # 系统健康和信息
│   └── Admin/                 # 仅管理员端点
├── Services/                  # 业务逻辑层
│   ├── Auth/                  # JWT、用户上下文、认证
│   ├── Repositories/          # 仓库分析、处理、增量更新
│   ├── Wiki/                  # Wiki 生成（目录 + 内容 + 翻译）
│   ├── Chat/                  # 聊天助手、应用管理、嵌入服务
│   ├── MindMap/               # 思维导图生成
│   ├── Translation/           # 多语言翻译
│   ├── Admin/                 # 管理员统计、用户/角色管理
│   ├── Prompts/               # AI 提示模板加载
│   └── ...                    # OAuth、组织、订阅等
├── Agents/                    # AI 代理编排
│   ├── AgentFactory.cs        # 多提供商 AI 客户端工厂
│   ├── LoggingHttpHandler.cs  # HTTP 请求/响应日志
│   └── Tools/                 # AI 函数工具
├── Chat/                      # 聊天系统基础设施
│   ├── Providers/             # 聊天提供商实现
│   ├── Queue/                 # 消息队列处理
│   ├── Sessions/              # 会话管理
│   └── Routing/               # 提供商路由逻辑
├── Infrastructure/            # 横切关注点
│   ├── DatabaseServiceExtensions.cs  # 数据库提供商注册
│   ├── DbInitializer.cs      # 数据库初始化和种子数据
│   └── SerilogConfiguration.cs       # 结构化日志设置
├── Models/                    # 请求/响应 DTO
└── prompts/                   # AI 提示模板文件（Markdown）
    ├── catalog-generator.md
    ├── content-generator.md
    ├── incremental-updater.md
    └── mindmap-generator.md
```

## 最小 API 端点

后端使用 ASP.NET Core 最小 API，路由组按域组织。每个端点文件定义一个静态扩展方法来注册路由：

```csharp
public static class ChatAssistantEndpoints
{
    public static IEndpointRouteBuilder MapChatAssistantEndpoints(
        this IEndpointRouteBuilder app)
    {
        var group = app.MapGroup("/api/v1/chat")
            .WithTags("Chat Assistant");

        group.MapGet("/config", GetChatConfigAsync);
        group.MapGet("/models", GetAvailableModelsAsync);
        group.MapPost("/stream", StreamChatAsync);

        return app;
    }
}
```

所有端点在 `Program.cs` 中注册：

```csharp
app.MapMiniApis();
app.MapAuthEndpoints();
app.MapOAuthEndpoints();
app.MapAdminEndpoints();
app.MapChatAssistantEndpoints();
app.MapChatAppEndpoints();
app.MapEmbedEndpoints();
app.MapIncrementalUpdateEndpoints();
// ...
```

## 服务层

服务实现核心业务逻辑，通过 `Program.cs` 中的依赖注入注册。关键服务包括：

| 服务 | 接口 | 职责 |
|--------|-----------|----------------|
| `WikiGenerator` | `IWikiGenerator` | 编排 AI 驱动的目录和内容生成 |
| `RepositoryAnalyzer` | `IRepositoryAnalyzer` | 通过 LibGit2Sharp 进行 Git 克隆/拉取操作 |
| `IncrementalUpdateService` | `IIncrementalUpdateService` | 管理增量更新任务 |
| `ChatAssistantService` | `IChatAssistantService` | SSE 流式聊天与文档上下文 |
| `TranslationService` | `ITranslationService` | 多语言文档翻译 |
| `EmbedService` | `IEmbedService` | 可嵌入小部件认证和聊天 |

## AI 集成（AgentFactory）

`AgentFactory` 是创建 AI 客户端的中央抽象。它通过统一接口支持多个提供商：

```csharp
public enum AiRequestType
{
    OpenAI,
    AzureOpenAI,
    OpenAIResponses,
    Anthropic
}
```

工厂创建配置了适当提供商、端点和 API 密钥的 `ChatClientAgent` 实例。Wiki 生成为不同任务使用单独的模型配置：

- **目录模型** — 生成文档结构/大纲（可使用更快、更便宜的模型）
- **内容模型** — 生成实际文档内容（受益于更强大的模型）
- **翻译模型** — 将文档翻译为其他语言（可选，回退到内容模型）

配置通过环境变量完成：

```
WIKI_CATALOG_MODEL, WIKI_CATALOG_ENDPOINT, WIKI_CATALOG_API_KEY
WIKI_CONTENT_MODEL, WIKI_CONTENT_ENDPOINT, WIKI_CONTENT_API_KEY
WIKI_TRANSLATION_MODEL, WIKI_TRANSLATION_ENDPOINT, WIKI_TRANSLATION_API_KEY
```

## 后台工作者

长时间运行的任务由 `IHostedService` 后台工作者处理：

| 工作者 | 描述 |
|--------|-------------|
| `RepositoryProcessingWorker` | 处理排队的仓库分析和 wiki 生成任务 |
| `TranslationWorker` | 处理文档翻译任务 |
| `MindMapWorker` | 为仓库分支生成思维导图内容 |
| `IncrementalUpdateWorker` | 定期检查和处理增量更新 |

工作者独立运行，使用 `IServiceScopeFactory` 为每个操作创建作用域数据库上下文。

## Entity Framework Core

数据层使用共享 `MasterDbContext` 基类和 `IContext` 接口：

```csharp
public interface IContext : IDisposable
{
    DbSet<Repository> Repositories { get; set; }
    DbSet<RepositoryBranch> RepositoryBranches { get; set; }
    DbSet<DocCatalog> DocCatalogs { get; set; }
    DbSet<DocFile> DocFiles { get; set; }
    DbSet<User> Users { get; set; }
    // ... 20+ 个实体集
    Task<int> SaveChangesAsync(CancellationToken cancellationToken = default);
}
```

数据库提供商在启动时通过 `DB_TYPE` 环境变量选择：

- `sqlite` — 使用 `SqliteDbContext`（默认，基于文件）
- `postgresql` — 使用 `PostgresqlDbContext`

## 认证

后端使用 JWT Bearer 认证：

- 通过 `IJwtService` 进行令牌生成和验证
- 通过 `IUserContext` 进行用户上下文提取
- 通过 `[RequireAuthorization]` 和角色检查进行仅管理员策略
- 第三方登录提供商的 OAuth 集成（GitHub、Gitee）

## Chat 系统

OpenDeepWiki 包含一个完整的多平台聊天系统，支持通过 Webhook 接入多种即时通讯平台：

### 支持的平台

| 平台 | Webhook 端点 | 描述 |
|------|-------------|------|
| 飞书 | `POST /api/chat/webhook/feishu` | 飞书机器人消息 |
| QQ | `POST /api/chat/webhook/qq` | QQ 机器人消息 |
| 微信 | `POST /api/chat/webhook/wechat` | 微信客服消息 |
| 通用 | `POST /api/chat/webhook/{platform}` | 自定义平台 |

### 架构组件

- **Providers** — 各平台的消息处理实现（飞书、QQ、微信等）
- **Queue** — 消息队列系统，支持异步处理和死信队列
- **Sessions** — 会话管理，维护用户对话上下文
- **Routing** — 提供商路由逻辑，根据平台分发消息

### Provider 管理

管理员可以通过 `/api/chat/admin/providers` 端点管理各平台的 Provider 配置，包括启用/禁用、配置更新和热重载。

## 管理系统

管理端（`/api/admin`）提供完整的后台管理功能：

| 模块 | 描述 |
|------|------|
| 统计数据 | 仪表盘统计、Token 消耗分析 |
| 仓库管理 | CRUD、状态管理、批量操作、统计同步 |
| 用户管理 | CRUD、状态管理、角色分配、密码重置 |
| 角色管理 | CRUD、权限配置 |
| 部门管理 | 组织架构、用户和仓库分配 |
| 工具配置 | MCP 服务器、Skill 插件、AI 模型管理 |
| 系统设置 | 全局配置管理 |
| 对话助手 | 助手配置和模型选择 |

## 关键依赖

| 包 | 用途 |
|---------|---------|
| `Microsoft.Agents.AI.*` | AI 代理框架（OpenAI、Azure、Anthropic） |
| `LibGit2Sharp` | Git 仓库操作（克隆、拉取、差异） |
| `Microsoft.EntityFrameworkCore` | ORM 和数据库访问 |
| `Serilog` | 结构化日志，支持文件和控制台输出 |
| `Scalar.AspNetCore` | OpenAPI 文档 UI |
| `BCrypt.Net-Next` | 密码哈希 |
| `YamlDotNet` | YAML 配置解析 |
